<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="WhyLayerã¯ã€ç›®çš„ã¨æ‰‹æ®µã®æ€è€ƒãƒ„ãƒªãƒ¼ã‚’è¦–è¦šçš„ã«æ§‹ç¯‰ãƒ»ä¿å­˜ãƒ»å…±æœ‰ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚èª°ã§ã‚‚ç°¡å˜ã«ã€è‡ªåˆ†ã®ã€ãªãœï¼Ÿã€ã‚’æ˜ã‚Šä¸‹ã’ã‚‰ã‚Œã¾ã™ã€‚">
  <title>WhyLayer - æ€è€ƒã‚’æ˜ã‚‹ãƒ„ãƒ¼ãƒ«</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§ </text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* ... çœç•¥: ã‚¹ã‚¿ã‚¤ãƒ«ã¯ãã®ã¾ã¾ ... */
  </style>
</head>
<body>
  <h1>ğŸ§  WhyLayer</h1>
  <div id="intro">ç›®çš„ã¨æ‰‹æ®µã®æ€è€ƒãƒ„ãƒªãƒ¼ã‚’æ˜ã‚Šä¸‹ã’ã‚‹ã€è»½é‡ã§ã‚·ãƒ³ãƒ—ãƒ«ãªWebãƒ„ãƒ¼ãƒ«</div>
  <div id="controls">
    <button onclick="downloadTree()">ä¿å­˜ï¼ˆJSONï¼‰</button>
    <input type="file" id="upload" accept="application/json" onchange="uploadTree(event)" style="display:none;" />
    <button onclick="document.getElementById('upload').click()">èª­ã¿è¾¼ã¿</button>
    <button onclick="exportAsImage()">ç”»åƒã¨ã—ã¦ä¿å­˜</button>
    <button onclick="exportAsPDF()">PDFã¨ã—ã¦ä¿å­˜</button>
    <button class="toggle-dark" onclick="toggleDarkMode()">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
  </div>
  <div id="tree"></div>

  <script>
    let nodeId = 0;
    function createNode(text = '', color = '') {
      return { id: nodeId++, text, color, children: [] };
    }

    let root = createNode('å‘¨ã‚Šã®äººãŒä½¿ã„ã‚„ã™ã„ãƒ„ãƒ¼ãƒ«ã‚’ä½œã‚‹');
    const node1 = createNode('ãªãœï¼Ÿ â†’ å‘¨ã‚Šã®äººã«ä½¿ã£ã¦ã»ã—ã„ã‹ã‚‰');
    const node2 = createNode('ãªãœï¼Ÿ â†’ æƒ…å ±æ ¼å·®ã‚’æ„Ÿã˜ã‚‹ã‹ã‚‰');
    const node3 = createNode('ãªãœï¼Ÿ â†’ ã©ã‚“ãªäººã«ã‚‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’');
    root.children.push(node1);
    node1.children.push(node2);
    node2.children.push(node3);

    function renderNode(node, container, parent = null) {
      const nodeEl = document.createElement('div');
      nodeEl.className = 'node';
      if (node.color) nodeEl.style.borderLeft = `8px solid ${node.color}`;

      const input = document.createElement('input');
      input.value = node.text;
      input.addEventListener('input', () => node.text = input.value);

      const btnContainer = document.createElement('div');
      btnContainer.className = 'buttons';

      const whyBtn = document.createElement('button');
      whyBtn.textContent = 'ãªãœï¼Ÿã‚’è¿½åŠ ';
      whyBtn.onclick = () => {
        const child = createNode('ãªãœï¼Ÿ â†’ ');
        node.children.push(child);
        renderTree();
      };

      const howBtn = document.createElement('button');
      howBtn.textContent = 'ã©ã†ã‚„ã£ã¦ï¼Ÿã‚’è¿½åŠ ';
      howBtn.onclick = () => {
        const child = createNode('ã©ã†ã‚„ã£ã¦ï¼Ÿ â†’ ');
        node.children.push(child);
        renderTree();
      };

      const colorBtn = document.createElement('button');
      colorBtn.textContent = 'è‰²è¨­å®š';
      colorBtn.onclick = () => {
        const picked = prompt('è‰²ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: #facc15ï¼‰', node.color || '');
        if (picked) {
          node.color = picked;
          renderTree();
        }
      };

      btnContainer.appendChild(whyBtn);
      btnContainer.appendChild(howBtn);
      btnContainer.appendChild(colorBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'âœ•';
      deleteBtn.className = 'delete-btn';
      deleteBtn.onclick = () => {
        if (parent) {
          const index = parent.children.indexOf(node);
          if (index !== -1) {
            parent.children.splice(index, 1);
            renderTree();
          }
        }
      };

      nodeEl.appendChild(deleteBtn);
      nodeEl.appendChild(input);
      nodeEl.appendChild(btnContainer);

      const childrenEl = document.createElement('div');
      childrenEl.className = 'children';
      nodeEl.appendChild(childrenEl);
      container.appendChild(nodeEl);

      node.children.forEach(child => renderNode(child, childrenEl, node));

      Sortable.create(childrenEl, {
        animation: 150,
        onEnd: evt => {
          const [moved] = node.children.splice(evt.oldIndex, 1);
          node.children.splice(evt.newIndex, 0, moved);
        }
      });
    }

    function renderTree() {
      const treeContainer = document.getElementById('tree');
      treeContainer.innerHTML = '';
      renderNode(root, treeContainer);
    }

    function downloadTree() {
      const dataStr = JSON.stringify(root, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'whylayer_tree.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function uploadTree(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const json = JSON.parse(e.target.result);
          nodeId = 0;
          function rebuildIds(node) {
            node.id = nodeId++;
            node.children.forEach(rebuildIds);
          }
          root = json;
          rebuildIds(root);
          renderTree();
        } catch (err) {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      };
      reader.readAsText(file);
    }

    function exportAsImage() {
      html2canvas(document.getElementById('tree')).then(canvas => {
        const link = document.createElement('a');
        link.download = 'whylayer_tree.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    function exportAsPDF() {
      html2canvas(document.getElementById('tree')).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save('whylayer_tree.pdf');
      });
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }

    renderTree();
  </script>
</body>
</html>
